{
  "metadata": {
    "name": "update-v-v1"
  },
  "spec": {
    "rootResource": "update",
    "firstStage": "check-update",
    "selfDriving": true,
    "stages": {
      "check-update": {
        "name": "check-update",
        "provider": "providers.stage.http",
        "config": {
          "name": "test",
          "url": "http://localhost:8085/check-update",
          "method": "POST",
          "successCodes": [
            200
          ]
        },
        "inputs": {
          "body": {
            "app-to-update": "${{$trigger(app-to-update, {})}}",
            "conditions": "${{$trigger(conditions, {})}}"
          }
        },
        "stageSelector": "${{$if($output(check-update, statusCode), 200), update, end)}}"
      },
      "update": {
        "name": "update",
        "provider": "providers.stage.http",
        "config": {
          "name": "test",
          "url": "http://localhost:8085/update",
          "method": "POST",
          "successCodes": [
            200,
            202
          ]
        },
        "inputs": {
          "body": {
            "target": "${{$trigger(target, {})}}",
            "conditions": "${{$trigger(conditions, {})}}"
          }
        },
        "stageSelector": "${{$if($output(update, statusCode), 200), health-check, rollback)}}"
      },
      "health-check": {
        "name": "health-check",
        "provider": "providers.stage.http",
        "config": {
          "name": "test",
          "url": "http://localhost:8085/health-check",
          "method": "POST",
          "successCodes": [
            200,
            202
          ]
        },
        "stageSelector": "${{$if($output(health-check, statusCode), 200), end, rollback)}}"
      },
      "rollback": {
        "name": "rollback",
        "provider": "providers.stage.http",
        "config": {
          "name": "test",
          "url": "http://localhost:8085/rollback",
          "method": "POST",
          "successCodes": [
            200,
            202
          ]
        },
        "inputs": {
          "body": {
            "rollback": "${{$trigger(rollback, {})}}",
            "conditions": "${{$trigger(conditions, {})}}"
          }
        }
      }
    }
  }
}
